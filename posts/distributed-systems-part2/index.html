<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Distributed systems concepts (Part 2)
        
    </title><meta content="Distributed systems concepts (Part 2)" property=og:title><link href=/icon/favicon.png rel=icon type=image/png><link href=https://carlosb1.github.io/fonts.css rel=stylesheet><link title="Carlos Baez" href=https://carlosb1.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://carlosb1.github.io/theme/light.css rel=stylesheet><link href=https://carlosb1.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://carlosb1.github.io/main.css media=screen rel=stylesheet><script src=https://carlosb1.github.io/js/feather.min.js></script><body><div class=content><header><div class=main><a href=https://carlosb1.github.io>Carlos Baez</a><div class=socials><a class=social href=mailto:carlos.baezruiz@gmail.com rel=me> <img alt=email src=/social_icons/email.svg> </a><a class=social href=https://github.com/carlosb1/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a><a href=/personal style=margin-left:.7em>/personal</a><a href=/about style=margin-left:.7em>/about</a></nav><nav>| <a href id=dark-mode-toggle onclick=toggleTheme()></a><script src=https://carlosb1.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Distributed systems concepts (Part 2)<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2023-09-29</time></div></div><section class=body><p>I implemented the domain logic for the <a href=https://martinfowler.com/articles/patterns-of-distributed-systems/lamport-clock.html>Lamport clock</a> synchronization.<p>We could apply the single responsibility, and split the network protocol library from the domain logic that it must be done. Furthermore, It is necessary to include some entity domain classes, but it is going to be in another module.<p>Here the domain logic for the client and server<pre class=language-Rust data-lang=Rust style=background:#0f1419;color:#bfbab0><code class=language-Rust data-lang=Rust><span style=color:#ff7733>use crate</span><span style=color:#f29668>::</span><span>adapters</span><span style=color:#f29668>::</span><span>lamport</span><span style=color:#f29668>::</span><span>LamportClock</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>use crate</span><span style=color:#f29668>::</span><span>adapters</span><span style=color:#f29668>::</span><span>network</span><span style=color:#f29668>::</span><span>message</span><span style=color:#f29668>::</span><span>{FromClientMessage</span><span style=color:#bfbab0cc>,</span><span> FromServerMessage}</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>use crate</span><span style=color:#f29668>::</span><span>adapters</span><span style=color:#f29668>::</span><span>network</span><span style=color:#f29668>::</span><span>net</span><span style=color:#f29668>::</span><span>{ClientDispatcher</span><span style=color:#bfbab0cc>,</span><span> ServerDispatcher}</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>use crate</span><span style=color:#f29668>::</span><span>entity</span><span style=color:#f29668>::</span><span>{SerializedValue</span><span style=color:#bfbab0cc>,</span><span> VersionedValue}</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>use </span><span>std</span><span style=color:#f29668>::</span><span>collections</span><span style=color:#f29668>::</span><span>HashMap</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=color:#bfbab0cc>#</span><span>[</span><span style=color:#ffb454>derive</span><span>(Clone</span><span style=color:#bfbab0cc>,</span><span> Default)]
</span><span style=color:#ff7733>pub struct </span><span style=color:#59c2ff>DistributedServerDispatcher </span><span>{
</span><span>    clock</span><span style=color:#bfbab0cc>:</span><span> LamportClock,
</span><span>    mvvc_store</span><span style=color:#bfbab0cc>: </span><span>HashMap&LTVersionedValue, SerializedValue>,
</span><span>}
</span><span>
</span><span style=color:#ff7733>impl </span><span style=color:#59c2ff>DistributedServerDispatcher </span><span>{
</span><span>    </span><span style=color:#ff7733>pub fn </span><span style=color:#ffb454>new</span><span>(
</span><span>        </span><span style=color:#f29718>clock</span><span style=color:#bfbab0cc>:</span><span> LamportClock,
</span><span>        </span><span style=color:#f29718>mvvc_store</span><span style=color:#bfbab0cc>: </span><span>HashMap&LTVersionedValue, SerializedValue>,
</span><span>    ) </span><span style=color:#bfbab0cc>-></span><span> DistributedServerDispatcher {
</span><span>        DistributedServerDispatcher { clock</span><span style=color:#bfbab0cc>,</span><span> mvvc_store }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#ff7733>pub fn </span><span style=color:#ffb454>write</span><span>(</span><span style=color:#f29668>&</span><span style=color:#ff7733>mut </span><span style=color:#f29718>self</span><span>, </span><span style=color:#f29718>key</span><span style=color:#bfbab0cc>:</span><span> String, </span><span style=color:#f29718>value</span><span style=color:#bfbab0cc>:</span><span> String, </span><span style=color:#f29718>request_time</span><span style=color:#bfbab0cc>: </span><span style=color:#ff7733>u64</span><span>) </span><span style=color:#bfbab0cc>-> </span><span style=color:#ff7733>u64 </span><span>{
</span><span>        log</span><span style=color:#f29668>::</span><span>info</span><span style=color:#f29668>!</span><span>(
</span><span>            </span><span style=color:#c2d94c>"I received a new entry from a client: {:}={:}, time={:}"</span><span style=color:#bfbab0cc>,
</span><span>            key</span><span style=color:#bfbab0cc>,
</span><span>            value</span><span style=color:#bfbab0cc>,
</span><span>            request_time
</span><span>        )</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>let</span><span> time </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>clock</span><span style=color:#f29668>.</span><span style=color:#f07178>tick</span><span>(request_time)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>mvvc_store</span><span style=color:#f29668>.</span><span style=color:#f07178>insert</span><span>(
</span><span>            VersionedValue</span><span style=color:#f29668>::</span><span>new(key</span><span style=color:#f29668>.</span><span style=color:#f07178>as_str</span><span>()</span><span style=color:#bfbab0cc>,</span><span> time)</span><span style=color:#bfbab0cc>,
</span><span>            SerializedValue</span><span style=color:#f29668>::</span><span>new(value)</span><span style=color:#bfbab0cc>,
</span><span>        )</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>return</span><span> time</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#ff7733>impl </span><span>ServerDispatcher </span><span style=color:#ff7733>for </span><span style=color:#59c2ff>DistributedServerDispatcher </span><span>{
</span><span>    </span><span style=color:#ff7733>fn </span><span style=color:#ffb454>dispatch</span><span>(</span><span style=color:#f29668>&</span><span style=color:#ff7733>mut </span><span style=color:#f29718>self</span><span>, </span><span style=color:#f29718>received</span><span style=color:#bfbab0cc>:</span><span> FromClientMessage) </span><span style=color:#bfbab0cc>-> </span><span style=font-style:italic;color:#39bae6>Option</span><span>&LTFromServerMessage> {
</span><span>        log</span><span style=color:#f29668>::</span><span>info</span><span style=color:#f29668>!</span><span>(</span><span style=color:#c2d94c>"I received a message from the client  {:?}"</span><span style=color:#bfbab0cc>,</span><span> received)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>match</span><span> received {
</span><span>            FromClientMessage</span><span style=color:#f29668>::</span><span>Write(key</span><span style=color:#bfbab0cc>,</span><span> value</span><span style=color:#bfbab0cc>,</span><span> clock) </span><span style=color:#f29668>=> </span><span>{
</span><span>                </span><span style=color:#ff7733>let</span><span> time </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#f07178>write</span><span>(key</span><span style=color:#bfbab0cc>,</span><span> value</span><span style=color:#bfbab0cc>,</span><span> clock)</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#39bae6>Some</span><span>(FromServerMessage</span><span style=color:#f29668>::</span><span>WrittenAt(time))
</span><span>            }
</span><span>            </span><span style=color:#f29668>_ => </span><span style=font-style:italic;color:#39bae6>Some</span><span>(FromServerMessage</span><span style=color:#f29668>::</span><span>UnknownPong)</span><span style=color:#bfbab0cc>,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#bfbab0cc>#</span><span>[</span><span style=color:#ffb454>derive</span><span>(Clone</span><span style=color:#bfbab0cc>,</span><span> Default)]
</span><span style=color:#ff7733>pub struct </span><span style=color:#59c2ff>DistributedClientDispatcher </span><span>{}
</span><span>
</span><span style=color:#ff7733>impl </span><span style=color:#59c2ff>DistributedClientDispatcher </span><span>{
</span><span>    </span><span style=color:#ff7733>pub fn </span><span style=color:#ffb454>new</span><span>() </span><span style=color:#bfbab0cc>-> </span><span style=color:#ff7733>Self </span><span>{
</span><span>        DistributedClientDispatcher {}
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#ff7733>impl </span><span>ClientDispatcher </span><span style=color:#ff7733>for </span><span style=color:#59c2ff>DistributedClientDispatcher </span><span>{
</span><span>    </span><span style=color:#ff7733>fn </span><span style=color:#ffb454>dispatch</span><span>(</span><span style=color:#f29668>&</span><span style=color:#ff7733>mut </span><span style=color:#f29718>self</span><span>, </span><span style=color:#f29718>received</span><span style=color:#bfbab0cc>:</span><span> FromServerMessage) </span><span style=color:#bfbab0cc>-> </span><span style=font-style:italic;color:#39bae6>Option</span><span>&LTFromClientMessage> {
</span><span>        log</span><span style=color:#f29668>::</span><span>info</span><span style=color:#f29668>!</span><span>(</span><span style=color:#c2d94c>"I received a message from the server  {:?}"</span><span style=color:#bfbab0cc>,</span><span> received)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>match</span><span> received {
</span><span>            FromServerMessage</span><span style=color:#f29668>::</span><span>WrittenAt(clock) </span><span style=color:#f29668>=> </span><span>{
</span><span>                log</span><span style=color:#f29668>::</span><span>info</span><span style=color:#f29668>!</span><span>(</span><span style=color:#c2d94c>"Received latest time from server: {:}"</span><span style=color:#bfbab0cc>,</span><span> clock)</span><span style=color:#bfbab0cc>;
</span><span>            }
</span><span>            </span><span style=color:#f29668>_ => </span><span>{
</span><span>                log</span><span style=color:#f29668>::</span><span>info</span><span style=color:#f29668>!</span><span>(</span><span style=color:#c2d94c>"Unknown response"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>            }
</span><span>        }
</span><span>        </span><span style=font-style:italic;color:#39bae6>None
</span><span>    }
</span><span>}
</span></code></pre><p>Here the entity domain modules<pre class=language-Rust data-lang=Rust style=background:#0f1419;color:#bfbab0><code class=language-Rust data-lang=Rust><span style=font-style:italic;color:#5c6773>/// Entity domain code, it defines the necessary
</span><span style=font-style:italic;color:#5c6773>/// relationship in the code.
</span><span style=color:#ff7733>use </span><span>std</span><span style=color:#f29668>::</span><span>str</span><span style=color:#f29668>::</span><span>FromStr</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=font-style:italic;color:#5c6773>/// Node network structure representaiton.
</span><span style=color:#bfbab0cc>#</span><span>[</span><span style=color:#ffb454>derive</span><span>(Clone)]
</span><span style=color:#ff7733>pub struct </span><span style=color:#59c2ff>Node </span><span>{
</span><span>    </span><span style=color:#ff7733>pub </span><span>address</span><span style=color:#bfbab0cc>:</span><span> String,
</span><span>}
</span><span>
</span><span style=color:#ff7733>impl </span><span style=color:#59c2ff>Node </span><span>{
</span><span>    </span><span style=color:#ff7733>pub fn </span><span style=color:#ffb454>from_env</span><span>() </span><span style=color:#bfbab0cc>-> </span><span style=color:#ff7733>Self </span><span>{
</span><span>        </span><span style=color:#ff7733>let</span><span> port </span><span style=color:#f29668>= </span><span>std</span><span style=color:#f29668>::</span><span>env</span><span style=color:#f29668>::</span><span>var(</span><span style=color:#c2d94c>"PORT"</span><span>)</span><span style=color:#f29668>.</span><span style=color:#f07178>unwrap_or</span><span>(</span><span style=color:#c2d94c>"3042"</span><span style=color:#f29668>.</span><span style=color:#f07178>to_string</span><span>())</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>let</span><span> host </span><span style=color:#f29668>= </span><span>std</span><span style=color:#f29668>::</span><span>env</span><span style=color:#f29668>::</span><span>var(</span><span style=color:#c2d94c>"HOST"</span><span>)</span><span style=color:#f29668>.</span><span style=color:#f07178>unwrap_or</span><span>(</span><span style=color:#c2d94c>"0.0.0.0"</span><span style=color:#f29668>.</span><span style=color:#f07178>to_string</span><span>())</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>let</span><span> address </span><span style=color:#f29668>= </span><span style=color:#f07178>format!</span><span>(</span><span style=color:#c2d94c>"</span><span style=color:#f29718>{:}</span><span style=color:#c2d94c>:</span><span style=color:#f29718>{:}</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span> host</span><span style=color:#bfbab0cc>,</span><span> port)</span><span style=color:#bfbab0cc>;
</span><span>        Node { address }
</span><span>    }
</span><span>}
</span><span style=color:#ff7733>impl </span><span>Default </span><span style=color:#ff7733>for </span><span style=color:#59c2ff>Node </span><span>{
</span><span>    </span><span style=color:#ff7733>fn </span><span style=color:#ffb454>default</span><span>() </span><span style=color:#bfbab0cc>-> </span><span style=color:#ff7733>Self </span><span>{
</span><span>        Node {
</span><span>            address</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"0.0.0.0:3042"</span><span style=color:#f29668>.</span><span style=color:#f07178>to_string</span><span>()</span><span style=color:#bfbab0cc>,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#bfbab0cc>#</span><span>[</span><span style=color:#ffb454>derive</span><span>(Clone</span><span style=color:#bfbab0cc>,</span><span> Hash</span><span style=color:#bfbab0cc>,</span><span> Eq</span><span style=color:#bfbab0cc>,</span><span> PartialEq</span><span style=color:#bfbab0cc>,</span><span> Debug)]
</span><span style=color:#ff7733>pub struct </span><span style=color:#59c2ff>VersionedValue </span><span>{
</span><span>    </span><span style=color:#ff7733>pub </span><span>key</span><span style=color:#bfbab0cc>:</span><span> String,
</span><span>    </span><span style=color:#ff7733>pub </span><span>time</span><span style=color:#bfbab0cc>: </span><span style=color:#ff7733>u64</span><span>,
</span><span>    versioned_value</span><span style=color:#bfbab0cc>:</span><span> String,
</span><span>}
</span><span>
</span><span style=color:#ff7733>impl </span><span style=color:#59c2ff>VersionedValue </span><span>{
</span><span>    </span><span style=color:#ff7733>pub fn </span><span style=color:#ffb454>new</span><span>(</span><span style=color:#f29718>key</span><span style=color:#bfbab0cc>: </span><span style=color:#f29668>&</span><span style=color:#ff7733>str</span><span>, </span><span style=color:#f29718>time</span><span style=color:#bfbab0cc>: </span><span style=color:#ff7733>u64</span><span>) </span><span style=color:#bfbab0cc>-> </span><span style=color:#ff7733>Self </span><span>{
</span><span>        </span><span style=color:#ff7733>let</span><span> versioned_value </span><span style=color:#f29668>= </span><span style=color:#f07178>format!</span><span>(</span><span style=color:#c2d94c>"</span><span style=color:#f29718>{:}</span><span style=color:#c2d94c>@</span><span style=color:#f29718>{:}</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span> key</span><span style=color:#f29668>.</span><span style=color:#f07178>to_string</span><span>()</span><span style=color:#bfbab0cc>,</span><span> time)</span><span style=color:#bfbab0cc>;
</span><span>        VersionedValue {
</span><span>            key</span><span style=color:#bfbab0cc>:</span><span> key</span><span style=color:#f29668>.</span><span style=color:#f07178>to_string</span><span>()</span><span style=color:#bfbab0cc>,
</span><span>            time</span><span style=color:#bfbab0cc>,
</span><span>            versioned_value</span><span style=color:#bfbab0cc>,
</span><span>        }
</span><span>    }
</span><span>}
</span><span style=color:#ff7733>impl </span><span>ToString </span><span style=color:#ff7733>for </span><span style=color:#59c2ff>VersionedValue </span><span>{
</span><span>    </span><span style=color:#ff7733>fn </span><span style=color:#ffb454>to_string</span><span>(</span><span style=color:#f29668>&</span><span style=color:#f29718>self</span><span>) </span><span style=color:#bfbab0cc>-></span><span> String {
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>versioned_value</span><span style=color:#f29668>.</span><span style=color:#f07178>clone</span><span>()
</span><span>    }
</span><span>}
</span><span style=color:#bfbab0cc>#</span><span>[</span><span style=color:#ffb454>derive</span><span>(Debug)]
</span><span style=color:#ff7733>pub struct </span><span style=color:#59c2ff>ParseVersionedError </span><span>{}
</span><span>
</span><span style=color:#ff7733>impl </span><span>FromStr </span><span style=color:#ff7733>for </span><span style=color:#59c2ff>VersionedValue </span><span>{
</span><span>    </span><span style=color:#ff7733>type </span><span style=color:#59c2ff>Err </span><span style=color:#f29668>=</span><span> ParseVersionedError</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>    </span><span style=color:#ff7733>fn </span><span style=color:#ffb454>from_str</span><span>(</span><span style=color:#f29718>s</span><span style=color:#bfbab0cc>: </span><span style=color:#f29668>&</span><span style=color:#ff7733>str</span><span>) </span><span style=color:#bfbab0cc>-> </span><span style=font-style:italic;color:#39bae6>Result</span><span><</span><span style=color:#ff7733>Self</span><span>, </span><span style=color:#ff7733>Self</span><span style=color:#f29668>::</span><span style=font-style:italic;color:#39bae6>Err</span><span>> {
</span><span>        </span><span style=color:#ff7733>let mut</span><span> splitted </span><span style=color:#f29668>=</span><span> s</span><span style=color:#f29668>.</span><span style=color:#f07178>split</span><span>(</span><span style=color:#c2d94c>"@"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>let</span><span> key </span><span style=color:#f29668>=</span><span> splitted</span><span style=color:#f29668>.</span><span style=color:#f07178>next</span><span>()</span><span style=color:#f29668>.</span><span style=color:#f07178>ok_or</span><span>(ParseVersionedError {})</span><span style=color:#f29668>?</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>let</span><span> time </span><span style=color:#f29668>=</span><span> splitted</span><span style=color:#f29668>.</span><span style=color:#f07178>next</span><span>()</span><span style=color:#f29668>.</span><span style=color:#f07178>ok_or</span><span>(ParseVersionedError {})</span><span style=color:#f29668>?</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=font-style:italic;color:#39bae6>Ok</span><span>(VersionedValue {
</span><span>            key</span><span style=color:#bfbab0cc>:</span><span> key</span><span style=color:#f29668>.</span><span style=color:#f07178>to_string</span><span>()</span><span style=color:#bfbab0cc>,
</span><span>            time</span><span style=color:#bfbab0cc>:</span><span> time</span><span style=color:#f29668>.</span><span>parse</span><span style=color:#f29668>::</span><span><</span><span style=color:#ff7733>u64</span><span>>()</span><span style=color:#f29668>.</span><span style=color:#f07178>map_err</span><span>(|_| ParseVersionedError {})</span><span style=color:#f29668>?</span><span style=color:#bfbab0cc>,
</span><span>            versioned_value</span><span style=color:#bfbab0cc>:</span><span> s</span><span style=color:#f29668>.</span><span style=color:#f07178>to_string</span><span>()</span><span style=color:#bfbab0cc>,
</span><span>        })
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#bfbab0cc>#</span><span>[</span><span style=color:#ffb454>derive</span><span>(Clone)]
</span><span style=color:#ff7733>pub struct </span><span style=color:#59c2ff>SerializedValue </span><span>{
</span><span>    value</span><span style=color:#bfbab0cc>:</span><span> String,
</span><span>}
</span><span>
</span><span style=color:#ff7733>impl </span><span>ToString </span><span style=color:#ff7733>for </span><span style=color:#59c2ff>SerializedValue </span><span>{
</span><span>    </span><span style=color:#ff7733>fn </span><span style=color:#ffb454>to_string</span><span>(</span><span style=color:#f29668>&</span><span style=color:#f29718>self</span><span>) </span><span style=color:#bfbab0cc>-></span><span> String {
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>value</span><span style=color:#f29668>.</span><span style=color:#f07178>clone</span><span>()
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#ff7733>impl </span><span style=color:#59c2ff>SerializedValue </span><span>{
</span><span>    </span><span style=color:#ff7733>pub fn </span><span style=color:#ffb454>new</span><span>(</span><span style=color:#f29718>value</span><span style=color:#bfbab0cc>:</span><span> String) </span><span style=color:#bfbab0cc>-> </span><span style=color:#ff7733>Self </span><span>{
</span><span>        SerializedValue { value }
</span><span>    }
</span><span>}
</span></code></pre></section></article></main></div>